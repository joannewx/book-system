<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</title>
    <!-- å¼•å…¥SheetJSåº“ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .description {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        
        .upload-section {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary {
            background-color: #2ecc71;
        }
        
        .btn-primary:hover {
            background-color: #27ae60;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
            box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: block;
            padding: 40px 20px;
            text-align: center;
            border: 3px dashed #3498db;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .file-label:hover {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: #2980b9;
        }
        
        .file-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .file-text {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .file-hint {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .preview-section {
            padding: 20px;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .preview-title {
            font-size: 20px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .preview-table th {
            background-color: #3498db;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        
        .preview-table th:last-child {
            border-right: none;
        }
        
        .preview-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            border-right: 1px solid #e0e0e0;
        }
        
        .preview-table tr:last-child td {
            border-bottom: none;
        }
        
        .preview-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .preview-table tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        .preview-table tr:nth-child(even):hover {
            background-color: #f1f3f4;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px 25px;
            background-color: #3498db;
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #eaeaea;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-total .stat-value {
            color: #3498db;
        }
        
        .stat-success .stat-value {
            color: #2ecc71;
        }
        
        .stat-skip .stat-value {
            color: #f39c12;
        }
        
        .stat-error .stat-value {
            color: #e74c3c;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border: 1px solid #c3e6cb;
            display: none;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border: 1px solid #f5c6cb;
            display: none;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .student-count {
            font-size: 18px;
            color: #2c3e50;
            margin: 20px 0;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #95a5a6;
        }
        
        .empty-icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 18px;
        }
        
        /* å…¨é€‰æ§åˆ¶æ ·å¼ */
        .select-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #eaeaea;
        }
        
        .select-all-checkbox {
            transform: scale(1.2);
            margin-right: 8px;
            cursor: pointer;
        }
        
        .select-label {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .selected-count {
            color: #3498db;
            font-weight: 600;
        }
        
        .row-checkbox {
            transform: scale(1.1);
            cursor: pointer;
        }
        
        /* æ‰¹é‡æ“ä½œå·¥å…·æ  */
        .batch-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background-color: #fff3cd;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
            display: none;
        }
        
        .batch-info {
            flex-grow: 1;
            color: #856404;
            font-weight: 500;
        }
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding: 15px;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .select-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .batch-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        .help-text {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .help-text h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .help-text ul {
            margin-left: 20px;
            color: #555;
        }
        
        .help-text li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="description">é€šè¿‡Excelæ–‡ä»¶æ‰¹é‡å¯¼å…¥å­¦ç”Ÿä¿¡æ¯ï¼Œæ”¯æŒ.xlsxã€.xlsã€.csvæ ¼å¼</p>
        </header>
        
        <div class="main-content">
            <div class="upload-section">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">å¯¼å…¥å­¦ç”Ÿä¿¡æ¯</h2>
                <p style="color: #7f8c8d; margin-bottom: 25px;">é€‰æ‹©åŒ…å«å­¦ç”Ÿä¿¡æ¯çš„Excelæ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è§£æå¹¶æ˜¾ç¤ºé¢„è§ˆã€‚</p>
                
                <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls,.csv" onchange="handleExcelUpload(event)">
                <label for="excelFile" class="file-label">
                    <div class="file-icon">ğŸ“</div>
                    <div class="file-text">ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶</div>
                    <div class="file-hint">æ”¯æŒ .xlsx, .xls, .csv æ ¼å¼</div>
                </label>
                
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="clearAllData()">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®
                    </button>
                    
                    <button class="btn" onclick="showAllStudents()">
                        ğŸ‘¥ æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿ
                    </button>
                    
                    <button class="btn btn-danger" onclick="showDeleteModal()">
                        ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤å­¦ç”Ÿ
                    </button>
                </div>
                
                <div class="help-text">
                    <h3>Excelæ–‡ä»¶æ ¼å¼è¯´æ˜</h3>
                    <ul>
                        <li>ç¬¬ä¸€è¡Œåº”ä¸ºè¡¨å¤´ï¼ŒåŒ…å«å­—æ®µå</li>
                        <li>æ”¯æŒçš„å­—æ®µï¼šå­¦å·ã€å§“åã€æ€§åˆ«ã€ç­çº§ã€ä¸“ä¸šã€å­¦é™¢ã€é‚®ç®±ã€å…¥å­¦æ—¥æœŸã€å‡ºç”Ÿæ—¥æœŸã€ç±è´¯ã€æ°‘æ—ã€æ”¿æ²»é¢è²Œ</li>
                        <li>å¿…å¡«å­—æ®µï¼šå­¦å·ã€å§“å</li>
                        <li>æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD æˆ– YYYY/MM/DD</li>
                    </ul>
                </div>
            </div>
            
            <div class="preview-section">
                <div class="preview-header">
                    <div class="preview-title">æ•°æ®é¢„è§ˆ</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="importConfirmBtn" class="btn btn-primary" onclick="confirmImport()" style="display: none;">
                            âœ… ç¡®è®¤å¯¼å…¥
                        </button>
                        <button class="btn btn-secondary" onclick="clearPreview()">
                            ğŸ—‘ï¸ æ¸…ç©ºé¢„è§ˆ
                        </button>
                    </div>
                </div>
                
                <div id="studentCount" class="student-count" style="display: none;">
                    å½“å‰å…±æœ‰ <span id="totalStudents">0</span> åå­¦ç”Ÿ
                </div>
                
                <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
                <div id="batchToolbar" class="batch-toolbar">
                    <div class="batch-info">
                        å·²é€‰æ‹© <span id="selectedCount">0</span> åå­¦ç”Ÿ
                    </div>
                    <button class="btn btn-danger" onclick="deleteSelected()">
                        ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­
                    </button>
                    <button class="btn btn-secondary" onclick="clearSelection()">
                        âœ–ï¸ å–æ¶ˆé€‰æ‹©
                    </button>
                </div>
                
                <div id="importPreview">
                    <div class="empty-state">
                        <div class="file-icon">ğŸ“Š</div>
                        <div class="empty-text">è¯·ä¸Šä¼ Excelæ–‡ä»¶æŸ¥çœ‹æ•°æ®é¢„è§ˆ</div>
                    </div>
                </div>
                
                <div id="importSuccess" class="success-message"></div>
                <div id="importError" class="error-message"></div>
                
                <div class="stats" style="display: none;" id="statsSection">
                    <div class="stat-card stat-total">
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">æ€»æ•°æ®</div>
                    </div>
                    <div class="stat-card stat-success">
                        <div class="stat-value" id="statSuccess">0</div>
                        <div class="stat-label">æˆåŠŸ</div>
                    </div>
                    <div class="stat-card stat-skip">
                        <div class="stat-value" id="statSkip">0</div>
                        <div class="stat-label">è·³è¿‡</div>
                    </div>
                    <div class="stat-card stat-error">
                        <div class="stat-value" id="statError">0</div>
                        <div class="stat-label">å¤±è´¥</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿæ¨¡æ€æ¡† -->
    <div id="allStudentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ‰€æœ‰å­¦ç”Ÿä¿¡æ¯</div>
                <button class="modal-close" onclick="closeAllStudentsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="allStudentsList" style="max-height: 400px; overflow-y: auto;">
                    <!-- å­¦ç”Ÿåˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAllStudentsModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- æ‰¹é‡åˆ é™¤æ¨¡æ€æ¡† -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #e74c3c;">
                <div class="modal-title">æ‰¹é‡åˆ é™¤å­¦ç”Ÿ</div>
                <button class="modal-close" onclick="hideModal('deleteModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="select-controls">
                    <input type="checkbox" id="selectAll" class="select-all-checkbox" onchange="toggleSelectAll(this)">
                    <label for="selectAll" class="select-label">å…¨é€‰æ‰€æœ‰å­¦ç”Ÿ</label>
                    <div class="selected-count">å·²é€‰æ‹©ï¼š<span id="modalSelectedCount">0</span> å</div>
                </div>
                
                <div id="deleteStudentsList" style="max-height: 400px; overflow-y: auto; border: 1px solid #eaeaea; border-radius: 6px; padding: 10px;">
                    <!-- åˆ é™¤åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background-color: #f8d7da; border-radius: 6px; border: 1px solid #f5c6cb;">
                    <strong>âš ï¸ è­¦å‘Šï¼š</strong>åˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼è¯·è°¨æ…æ“ä½œã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('deleteModal')">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="performBatchDelete()">
                    ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤é€‰ä¸­å­¦ç”Ÿ
                </button>
            </div>
        </div>
    </div>

    <script>
        // å­˜å‚¨é€‰ä¸­çš„å­¦ç”ŸID
        let selectedStudentIds = new Set();
        
        // åˆå§‹åŒ–å­˜å‚¨
        if (!localStorage.getItem('students')) {
            localStorage.setItem('students', JSON.stringify([]));
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        // éšè—æ¨¡æ€æ¡†
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // å¤„ç†Excelæ–‡ä»¶ä¸Šä¼ 
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                alert('è¯·ä¸Šä¼ Excelæ–‡ä»¶ (.xlsx, .xls, .csv)!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        alert('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®ï¼');
                        return;
                    }
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    showImportPreview(jsonData);
                } catch (error) {
                    alert('è¯»å–Excelæ–‡ä»¶å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsBinaryString(file);
        }
        
        // æ˜¾ç¤ºå¯¼å…¥é¢„è§ˆ
        function showImportPreview(data) {
            const previewTable = document.getElementById('importPreview');
            previewTable.innerHTML = '';
            
            if (data.length === 0) {
                previewTable.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“Š</div>
                        <div class="empty-text">Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®</div>
                    </div>
                `;
                return;
            }
            
            // åˆ›å»ºè¡¨æ ¼
            const table = document.createElement('table');
            table.className = 'preview-table';
            
            // åˆ›å»ºè¡¨å¤´
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // æ·»åŠ é€‰æ‹©åˆ—
            const selectHeader = document.createElement('th');
            selectHeader.innerHTML = '<input type="checkbox" class="select-all-checkbox" onchange="togglePreviewSelectAll(this)">';
            selectHeader.style.width = '50px';
            headerRow.appendChild(selectHeader);
            
            // è·å–æ‰€æœ‰å¯èƒ½çš„å­—æ®µåï¼ˆåˆå¹¶æ‰€æœ‰è¡Œçš„å­—æ®µï¼‰
            const allFields = new Set();
            data.forEach(row => {
                Object.keys(row).forEach(key => allFields.add(key));
            });
            
            // å¸¸ç”¨å­—æ®µæ’åº
            const fieldPriority = ['å­¦å·', 'å§“å', 'æ€§åˆ«', 'ç­çº§', 'ä¸“ä¸š', 'å­¦é™¢', 'é‚®ç®±', 'å…¥å­¦æ—¥æœŸ', 'å‡ºç”Ÿæ—¥æœŸ', 'ç±è´¯', 'æ°‘æ—', 'æ”¿æ²»é¢è²Œ'];
            const sortedFields = [...allFields].sort((a, b) => {
                const indexA = fieldPriority.indexOf(a);
                const indexB = fieldPriority.indexOf(b);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.localeCompare(b);
            });
            
            // æ·»åŠ è¡¨å¤´å•å…ƒæ ¼
            sortedFields.forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // åˆ›å»ºæ•°æ®è¡Œï¼ˆæœ€å¤šæ˜¾ç¤º10è¡Œé¢„è§ˆï¼‰
            const tbody = document.createElement('tbody');
            const previewRows = Math.min(data.length, 10);
            
            // ä¸ºå¯¼å…¥æ•°æ®æ·»åŠ ä¸´æ—¶ID
            window.importData = data.map((item, index) => ({
                ...item,
                _tempId: index + 1 // æ·»åŠ ä¸´æ—¶IDç”¨äºé€‰æ‹©
            }));
            
            for (let i = 0; i < previewRows; i++) {
                const row = document.createElement('tr');
                const rowData = window.importData[i];
                
                // æ·»åŠ é€‰æ‹©æ¡†
                const selectCell = document.createElement('td');
                selectCell.innerHTML = `<input type="checkbox" class="row-checkbox" data-index="${i}" onchange="togglePreviewRowSelection(this)">`;
                selectCell.style.textAlign = 'center';
                row.appendChild(selectCell);
                
                sortedFields.forEach(key => {
                    const td = document.createElement('td');
                    let value = rowData[key];
                    
                    if (value === undefined || value === null) {
                        value = '';
                    } else if (typeof value === 'object') {
                        value = JSON.stringify(value);
                    } else {
                        value = value.toString();
                    }
                    
                    // æˆªæ–­è¿‡é•¿çš„æ–‡æœ¬
                    if (value.length > 50) {
                        value = value.substring(0, 47) + '...';
                    }
                    
                    td.textContent = value;
                    td.title = value; // æ·»åŠ æç¤º
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
            previewTable.appendChild(table);
            
            // æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡
            document.getElementById('studentCount').style.display = 'block';
            document.getElementById('totalStudents').textContent = data.length;
            
            // æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡
            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('statTotal').textContent = data.length;
            document.getElementById('statSuccess').textContent = '0';
            document.getElementById('statSkip').textContent = '0';
            document.getElementById('statError').textContent = '0';
            
            // æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
            document.getElementById('importConfirmBtn').style.display = 'inline-block';
            
            // éšè—æˆåŠŸ/é”™è¯¯æ¶ˆæ¯
            document.getElementById('importSuccess').style.display = 'none';
            document.getElementById('importError').style.display = 'none';
            
            // æ˜¾ç¤ºé¢„è§ˆä¿¡æ¯
            alert(`æˆåŠŸè¯»å– ${data.length} æ¡æ•°æ®ï¼Œæ˜¾ç¤ºå‰ ${previewRows} æ¡é¢„è§ˆã€‚`);
        }
        
        // åˆ‡æ¢é¢„è§ˆè¡Œé€‰æ‹©
        function togglePreviewRowSelection(checkbox) {
            const index = parseInt(checkbox.dataset.index);
            const row = checkbox.closest('tr');
            
            if (checkbox.checked) {
                row.style.backgroundColor = '#e8f4fc';
                window.selectedPreviewRows = window.selectedPreviewRows || new Set();
                window.selectedPreviewRows.add(index);
            } else {
                row.style.backgroundColor = '';
                if (window.selectedPreviewRows) {
                    window.selectedPreviewRows.delete(index);
                }
            }
            
            updatePreviewSelectionCount();
        }
        
        // å…¨é€‰é¢„è§ˆè¡Œ
        function togglePreviewSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('#importPreview .row-checkbox');
            const rows = document.querySelectorAll('#importPreview tbody tr');
            window.selectedPreviewRows = window.selectedPreviewRows || new Set();
            
            if (checkbox.checked) {
                checkboxes.forEach(cb => cb.checked = true);
                rows.forEach(row => row.style.backgroundColor = '#e8f4fc');
                for (let i = 0; i < checkboxes.length; i++) {
                    window.selectedPreviewRows.add(i);
                }
            } else {
                checkboxes.forEach(cb => cb.checked = false);
                rows.forEach(row => row.style.backgroundColor = '');
                window.selectedPreviewRows.clear();
            }
            
            updatePreviewSelectionCount();
        }
        
        // æ›´æ–°é¢„è§ˆé€‰æ‹©è®¡æ•°
        function updatePreviewSelectionCount() {
            const count = window.selectedPreviewRows ? window.selectedPreviewRows.size : 0;
            if (count > 0) {
                document.getElementById('batchToolbar').style.display = 'flex';
                document.getElementById('selectedCount').textContent = count;
            } else {
                document.getElementById('batchToolbar').style.display = 'none';
            }
        }
        
        // ç¡®è®¤å¯¼å…¥æ•°æ®
        function confirmImport() {
            if (!window.importData || window.importData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®ï¼');
                return;
            }
            
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const existingStudentIds = new Set(students.map(student => student.studentId));
            
            let successCount = 0;
            let skipCount = 0;
            let errorCount = 0;
            
            // è·å–ç°æœ‰æœ€å¤§ID
            let maxId = students.length > 0 ? Math.max(...students.map(s => s.id)) : 0;
            
            // å¦‚æœé€‰æ‹©äº†éƒ¨åˆ†æ•°æ®ï¼Œåªå¯¼å…¥é€‰ä¸­çš„
            let dataToImport = window.importData;
            if (window.selectedPreviewRows && window.selectedPreviewRows.size > 0) {
                dataToImport = window.importData.filter((item, index) => window.selectedPreviewRows.has(index));
            }
            
            dataToImport.forEach((item, index) => {
                try {
                    // æ£€æŸ¥å¿…è¦å­—æ®µ
                    const studentId = item.å­¦å· || item.studentId || item.å­¦å· || item['Student ID'] || '';
                    const name = item.å§“å || item.name || item.å§“å || item.Name || '';
                    
                    if (!studentId || !name) {
                        console.warn(`ç¬¬${index + 1}è¡Œï¼šç¼ºå°‘å­¦å·æˆ–å§“åï¼Œè·³è¿‡`);
                        skipCount++;
                        return;
                    }
                    
                    // æ£€æŸ¥å­¦å·æ˜¯å¦å·²å­˜åœ¨
                    if (existingStudentIds.has(studentId)) {
                        console.warn(`ç¬¬${index + 1}è¡Œï¼šå­¦å· ${studentId} å·²å­˜åœ¨ï¼Œè·³è¿‡`);
                        skipCount++;
                        return;
                    }
                    
                    // åˆ›å»ºæ–°å­¦ç”Ÿå¯¹è±¡
                    const newStudent = {
                        id: ++maxId,
                        studentId: studentId,
                        name: name,
                        gender: item.æ€§åˆ« || item.gender || item.Gender || 'æœªçŸ¥',
                        className: item.ç­çº§ || item.class || item.ç­çº§ || item.Class || '',
                        major: item.ä¸“ä¸š || item.major || item.ä¸“ä¸š || item.Major || '',
                        college: item.å­¦é™¢ || item.college || item.å­¦é™¢ || item.College || '',
                        email: item.é‚®ç®± || item.email || item.é‚®ç®± || item.Email || '',
                        enrollmentDate: item.å…¥å­¦æ—¥æœŸ || item.enrollmentDate || item['Enrollment Date'] || '',
                        birthDate: item.å‡ºç”Ÿæ—¥æœŸ || item.birthDate || item['Birth Date'] || '',
                        hometown: item.ç±è´¯ || item.hometown || item.ç±è´¯ || '',
                        ethnicity: item.æ°‘æ— || item.ethnicity || item.æ°‘æ— || '',
                        politicalStatus: item.æ”¿æ²»é¢è²Œ || item.politicalStatus || item['Political Status'] || '',
                        status: 'åœ¨è¯»',
                        createTime: new Date().toISOString()
                    };
                    
                    students.push(newStudent);
                    existingStudentIds.add(studentId);
                    successCount++;
                    
                } catch (error) {
                    console.error(`ç¬¬${index + 1}è¡Œå¤„ç†å¤±è´¥ï¼š`, error);
                    errorCount++;
                }
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('students', JSON.stringify(students));
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            document.getElementById('statSuccess').textContent = successCount;
            document.getElementById('statSkip').textContent = skipCount;
            document.getElementById('statError').textContent = errorCount;
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const successElement = document.getElementById('importSuccess');
            successElement.innerHTML = `
                <strong>å¯¼å…¥å®Œæˆï¼</strong><br>
                æˆåŠŸå¯¼å…¥: ${successCount} åå­¦ç”Ÿ<br>
                è·³è¿‡: ${skipCount} æ¡æ•°æ®ï¼ˆå­¦å·é‡å¤æˆ–ç¼ºå°‘å¿…è¦ä¿¡æ¯ï¼‰<br>
                å¤±è´¥: ${errorCount} æ¡æ•°æ®
            `;
            successElement.style.display = 'block';
            
            // éšè—ç¡®è®¤æŒ‰é’®
            document.getElementById('importConfirmBtn').style.display = 'none';
            
            // æ›´æ–°å­¦ç”Ÿæ€»æ•°æ˜¾ç¤º
            document.getElementById('totalStudents').textContent = students.length;
            
            // æ¸…é™¤ä¸Šä¼ çš„æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('excelFile');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // æ¸…é™¤ç¼“å­˜çš„æ•°æ®
            window.importData = null;
            window.selectedPreviewRows = null;
            document.getElementById('batchToolbar').style.display = 'none';
        }
        
        // æ¸…ç©ºé¢„è§ˆ
        function clearPreview() {
            const previewTable = document.getElementById('importPreview');
            previewTable.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“Š</div>
                    <div class="empty-text">è¯·ä¸Šä¼ Excelæ–‡ä»¶æŸ¥çœ‹æ•°æ®é¢„è§ˆ</div>
                </div>
            `;
            
            document.getElementById('importConfirmBtn').style.display = 'none';
            document.getElementById('importSuccess').style.display = 'none';
            document.getElementById('importError').style.display = 'none';
            document.getElementById('studentCount').style.display = 'none';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('batchToolbar').style.display = 'none';
            
            const fileInput = document.getElementById('excelFile');
            if (fileInput) {
                fileInput.value = '';
            }
            
            window.importData = null;
            window.selectedPreviewRows = null;
        }
        
        // æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿ
        function showAllStudents() {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const listContainer = document.getElementById('allStudentsList');
            
            if (students.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘¤</div>
                        <div class="empty-text">æš‚æ— å­¦ç”Ÿä¿¡æ¯</div>
                    </div>
                `;
            } else {
                let html = `
                    <div style="margin-bottom: 15px; color: #2c3e50; font-weight: 500;">
                        å…±æœ‰ ${students.length} åå­¦ç”Ÿ
                    </div>
                    <table class="preview-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 50px;">é€‰æ‹©</th>
                                <th>å­¦å·</th>
                                <th>å§“å</th>
                                <th>æ€§åˆ«</th>
                                <th>ç­çº§</th>
                                <th>ä¸“ä¸š</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                students.slice(0, 50).forEach((student, index) => {
                    const isSelected = selectedStudentIds.has(student.id);
                    html += `
                        <tr id="student-row-${student.id}" ${isSelected ? 'style="background-color: #e8f4fc;"' : ''}>
                            <td style="text-align: center;">
                                <input type="checkbox" class="row-checkbox" 
                                       ${isSelected ? 'checked' : ''}
                                       onchange="toggleStudentSelection(${student.id}, this)">
                            </td>
                            <td>${student.studentId || ''}</td>
                            <td>${student.name || ''}</td>
                            <td>${student.gender || ''}</td>
                            <td>${student.className || ''}</td>
                            <td>${student.major || ''}</td>
                            <td><span style="color: #2ecc71;">${student.status || 'åœ¨è¯»'}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                if (students.length > 50) {
                    html += `
                        <div style="text-align: center; margin-top: 15px; color: #7f8c8d;">
                            åªæ˜¾ç¤ºå‰50æ¡è®°å½•ï¼Œå…±æœ‰${students.length}æ¡è®°å½•
                        </div>
                    `;
                }
                
                listContainer.innerHTML = html;
            }
            
            showModal('allStudentsModal');
        }
        
        // åˆ‡æ¢å­¦ç”Ÿé€‰æ‹©
        function toggleStudentSelection(studentId, checkbox) {
            const row = document.getElementById(`student-row-${studentId}`);
            
            if (checkbox.checked) {
                selectedStudentIds.add(studentId);
                if (row) row.style.backgroundColor = '#e8f4fc';
            } else {
                selectedStudentIds.delete(studentId);
                if (row) row.style.backgroundColor = '';
            }
            
            updateSelectedCount();
        }
        
        // å…¨é€‰æ‰€æœ‰å­¦ç”Ÿ
        function toggleSelectAll(checkbox) {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const checkboxes = document.querySelectorAll('#deleteStudentsList .row-checkbox');
            
            if (checkbox.checked) {
                selectedStudentIds.clear();
                students.forEach(student => selectedStudentIds.add(student.id));
                checkboxes.forEach(cb => cb.checked = true);
            } else {
                selectedStudentIds.clear();
                checkboxes.forEach(cb => cb.checked = false);
            }
            
            updateSelectedCount();
        }
        
        // æ›´æ–°é€‰æ‹©è®¡æ•°
        function updateSelectedCount() {
            document.getElementById('modalSelectedCount').textContent = selectedStudentIds.size;
        }
        
        // å…³é—­æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿæ¨¡æ€æ¡†
        function closeAllStudentsModal() {
            hideModal('allStudentsModal');
        }
        
        // æ˜¾ç¤ºåˆ é™¤æ¨¡æ€æ¡†
        function showDeleteModal() {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const listContainer = document.getElementById('deleteStudentsList');
            
            if (students.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘¤</div>
                        <div class="empty-text">æš‚æ— å­¦ç”Ÿä¿¡æ¯å¯åˆ é™¤</div>
                    </div>
                `;
                // ç¦ç”¨åˆ é™¤æŒ‰é’®
                document.querySelector('#deleteModal .btn-danger').disabled = true;
            } else {
                let html = `
                    <div style="margin-bottom: 15px; color: #2c3e50; font-weight: 500;">
                        å…±æœ‰ ${students.length} åå­¦ç”Ÿï¼Œè¯·é€‰æ‹©è¦åˆ é™¤çš„å­¦ç”Ÿ
                    </div>
                    <table class="preview-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 50px;">é€‰æ‹©</th>
                                <th>å­¦å·</th>
                                <th>å§“å</th>
                                <th>ç­çº§</th>
                                <th>ä¸“ä¸š</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                students.forEach(student => {
                    const isSelected = selectedStudentIds.has(student.id);
                    html += `
                        <tr id="delete-row-${student.id}" ${isSelected ? 'style="background-color: #e8f4fc;"' : ''}>
                            <td style="text-align: center;">
                                <input type="checkbox" class="row-checkbox" 
                                       ${isSelected ? 'checked' : ''}
                                       onchange="toggleStudentSelection(${student.id}, this)">
                            </td>
                            <td>${student.studentId || ''}</td>
                            <td>${student.name || ''}</td>
                            <td>${student.className || ''}</td>
                            <td>${student.major || ''}</td>
                            <td><span style="color: #2ecc71;">${student.status || 'åœ¨è¯»'}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                listContainer.innerHTML = html;
                // å¯ç”¨åˆ é™¤æŒ‰é’®
                document.querySelector('#deleteModal .btn-danger').disabled = false;
            }
            
            // æ›´æ–°é€‰æ‹©è®¡æ•°
            updateSelectedCount();
            showModal('deleteModal');
        }
        
        // æ‰§è¡Œæ‰¹é‡åˆ é™¤
        function performBatchDelete() {
            if (selectedStudentIds.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å­¦ç”Ÿï¼');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedStudentIds.size} åå­¦ç”Ÿå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            // è¿‡æ»¤æ‰é€‰ä¸­çš„å­¦ç”Ÿ
            const remainingStudents = students.filter(student => !selectedStudentIds.has(student.id));
            
            // ä¿å­˜å‰©ä½™çš„å­¦ç”Ÿ
            localStorage.setItem('students', JSON.stringify(remainingStudents));
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert(`æˆåŠŸåˆ é™¤ ${selectedStudentIds.size} åå­¦ç”Ÿï¼`);
            
            // æ¸…ç©ºé€‰æ‹©
            selectedStudentIds.clear();
            
            // å…³é—­æ¨¡æ€æ¡†
            hideModal('deleteModal');
            
            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            document.getElementById('totalStudents').textContent = remainingStudents.length;
            
            if (remainingStudents.length === 0) {
                document.getElementById('studentCount').style.display = 'none';
            }
        }
        
        // åˆ é™¤é€‰ä¸­çš„é¢„è§ˆè¡Œ
        function deleteSelected() {
            if (!window.selectedPreviewRows || window.selectedPreviewRows.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ•°æ®è¡Œï¼');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${window.selectedPreviewRows.size} æ¡æ•°æ®å—ï¼Ÿ`)) {
                return;
            }
            
            // è¿‡æ»¤æ‰é€‰ä¸­çš„æ•°æ®
            const remainingData = window.importData.filter((item, index) => !window.selectedPreviewRows.has(index));
            window.importData = remainingData;
            
            // é‡æ–°æ˜¾ç¤ºé¢„è§ˆ
            showImportPreview(remainingData);
            
            // æ¸…é™¤é€‰æ‹©
            window.selectedPreviewRows.clear();
            document.getElementById('batchToolbar').style.display = 'none';
            
            alert(`å·²åˆ é™¤ ${window.selectedPreviewRows.size} æ¡æ•°æ®ï¼Œå‰©ä½™ ${remainingData.length} æ¡æ•°æ®ã€‚`);
        }
        
        // æ¸…ç©ºé€‰æ‹©
        function clearSelection() {
            if (window.selectedPreviewRows) {
                window.selectedPreviewRows.clear();
            }
            
            const checkboxes = document.querySelectorAll('#importPreview .row-checkbox');
            const rows = document.querySelectorAll('#importPreview tbody tr');
            
            checkboxes.forEach(cb => cb.checked = false);
            rows.forEach(row => row.style.backgroundColor = '');
            
            document.getElementById('batchToolbar').style.display = 'none';
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            
            if (students.length === 0) {
                alert('å½“å‰æ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼');
                return;
            }
            
            if (confirm(`âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${students.length} åå­¦ç”Ÿæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                localStorage.setItem('students', JSON.stringify([]));
                clearPreview();
                selectedStudentIds.clear();
                alert('æ‰€æœ‰å­¦ç”Ÿæ•°æ®å·²æ¸…ç©ºï¼');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå­¦ç”Ÿæ€»æ•°
        window.onload = function() {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            if (students.length > 0) {
                document.getElementById('studentCount').style.display = 'block';
                document.getElementById('totalStudents').textContent = students.length;
            }
        };
    </script>
</body>
</html>
